stages:
  - test
  - docker

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DOCKER_TLS_CERTDIR: ""   # nécessaire avec docker:dind

cache:
  paths:
    - .cache/pip

# --------- JOB 1 : Tests + Lint ---------
test_and_lint:
  stage: test
  image: python:3.11
  before_script:
    - python --version
    - pip install -U pip
    - if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install -e .; fi
    - pip install pytest black flake8 requests
  script:
    # Run pytest tests
    - pytest tests/ -v || echo "⚠️ Tests failed (non-blocking)"
    # Format check
    - black --check api/ src/ || echo "⚠️ Format check failed (non-blocking)"
    # Lint
    - flake8 api/ src/ --count --select=E9,F63,F7,F82 --show-source --statistics || echo "⚠️ Lint check failed (non-blocking)"
    # Create dummy model for API test
    - mkdir -p models
    - python -c "import joblib; from sklearn.linear_model import LogisticRegression; from sklearn.pipeline import Pipeline; from sklearn.preprocessing import StandardScaler; pipe = Pipeline([('scaler', StandardScaler()), ('clf', LogisticRegression())]); joblib.dump(pipe, 'models/best_model.joblib')"
    # Test imports
    - python -c "from api.main import app; print('✅ API imports OK')"
    - python -c "import sys; sys.path.append('src'); from training.train_baseline import build_model; print('✅ Training imports OK')"
    # Test dependencies
    - python -c "import mlflow, sklearn, pandas, optuna, fastapi; print('✅ All imports OK')"
  rules:
    - if: $CI_COMMIT_BRANCH

# --------- JOB 2 : Build + Push Docker ---------
docker_build_push:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker info
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    # Create dummy model for Docker build
    - apk add --no-cache python3 py3-pip
    - pip3 install scikit-learn joblib numpy
    - mkdir -p models
    - python3 -c "import joblib; from sklearn.linear_model import LogisticRegression; from sklearn.pipeline import Pipeline; from sklearn.preprocessing import StandardScaler; pipe = Pipeline([('scaler', StandardScaler()), ('clf', LogisticRegression())]); joblib.dump(pipe, 'models/best_model.joblib')"
    # Build API image
    - docker build -t "$CI_REGISTRY_IMAGE/api:$CI_COMMIT_SHORT_SHA" -f Dockerfile .
    - docker push "$CI_REGISTRY_IMAGE/api:$CI_COMMIT_SHORT_SHA"
    # Build MLflow image
    - docker build -t "$CI_REGISTRY_IMAGE/mlflow:$CI_COMMIT_SHORT_SHA" -f Dockerfile.mlflow .
    - docker push "$CI_REGISTRY_IMAGE/mlflow:$CI_COMMIT_SHORT_SHA"
    # Tag latest if main branch
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        docker tag "$CI_REGISTRY_IMAGE/api:$CI_COMMIT_SHORT_SHA" "$CI_REGISTRY_IMAGE/api:latest"
        docker push "$CI_REGISTRY_IMAGE/api:latest"
        docker tag "$CI_REGISTRY_IMAGE/mlflow:$CI_COMMIT_SHORT_SHA" "$CI_REGISTRY_IMAGE/mlflow:latest"
        docker push "$CI_REGISTRY_IMAGE/mlflow:latest"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH

# --------- JOB 3 (BONUS) : Smoke Training ---------
smoke_train:
  stage: test
  image: python:3.11
  script:
    - pip install -U pip
    - pip install -r requirements.txt
    - python src/utils/load_data.py
    - python src/training/train_baseline.py --model logreg --C 1.0
    - python -c "import joblib; m = joblib.load('models/best_model.joblib'); print(f'✅ Model trained: {type(m)}')"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"
  allow_failure: true  # Non-blocking
